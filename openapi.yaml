openapi: 3.0.3

info:
  title: AnomalieAdresse API
  version: 2.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  description: |
    ## Workflow

    ![Workflow](./status.drawio.svg)


    ![Workflow](./status-attachment.drawio.svg)

    ## Types de signalement

    ![Types de signalement](./type.drawio.svg)


    ## Pagination

    Les listes de ressources sont paginées.

    * La valeur par défaut d'une page est `limit=50` et `offset=0`.
    * La valeur maximale de `limit` est `100`.

    ## Dépendances

    Cette API utilise une architecture proxyfié pour la gestion des dépendances.

    ![Proxyfied architecture schema](https://raw.githubusercontent.com/before-interop/common/v1/schema/architecture.drawio.svg)

    * [TroubleTicket](https://before-interop.github.io/common/v1/?urls.primaryName=TroubleTicket)
    * [Attachment](https://before-interop.github.io/common/v1/?urls.primaryName=Attachment)
    * [Note](https://before-interop.github.io/common/v1/?urls.primaryName=Note)
    * [Event](https://before-interop.github.io/common/v1/?urls.primaryName=Event)


    [Décision Arcep n° 2020-1432]: https://www.arcep.fr/uploads/tx_gsavis/20-1432.pdf
    [L33-1]: https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000047293234
    [L33-6]: https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000037671945

servers:
  - url: "{protocol}://{host}:{port}{basePath}"
    variables:
      protocol:
        enum:
          - https
          - http
        default: https
      host:
        default: localhost
      port:
        default: "8080"
      basePath:
        default: /api/v2

tags:
  - name: TroubleTicket
    description: TroubleTicket management
  - name: Note
    description: Note management
  - name: Attachment
    description: Attachment management
  - name: Event
    description: Event management
  - name: OI
    description: OI endpoints
  - name: OC
    description: OC endpoints

paths:
  /anomalie-adresse:
    get:
      operationId: getAllAnomalieAdresses
      tags:
        - TroubleTicket
        - OI
      summary: Get all trouble tickets
      description: Get all trouble tickets
      parameters: &searchAndPaginateParameters
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/limit
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/offset
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/sort
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The list of trouble tickets
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AnomalieAdresseBase"
        "400": &response400
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
          description: |
            **Bad Request**

            This error occurs when a query parameter or the body is invalid.

            * The `reason` field of the error response can contain information about the error.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - TroubleTicket
        - OI
      operationId: countAnomalieAdresses
      summary: Count the number of trouble tickets
      description: Count the number of trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of trouble tickets.
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - TroubleTicket
        - OI
      operationId: createAnomalieAdresse
      summary: Create a trouble ticket
      description: Create a trouble ticket
      requestBody:
        description: The trouble ticket to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseBase"
      responses:
        "201": &troubleTicket201
          description: The trouble ticket
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnomalieAdresseBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "403": &response403
          description: |
            **Forbidden**

            Le serveur a compris la requête, mais refuse de l'exécuter car le client n'a pas respecté le processus de création ou de mise à jour.

            Exemple: passage du status `ACKNOWLEDGED` à `RESOLVED` sans passer par le status `IN_PROGRESS`.

            * Le champ `reason` de la réponse d'erreur doit contenir la liste des tickets en conflit séparés par des virgules.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - TroubleTicket
        - OI
      operationId: getAnomalieAdresse
      summary: Get a trouble ticket
      description: Get a trouble ticket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
      responses:
        "200":
          description: The trouble ticket
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnomalieAdresseBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "404": &response404
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
          description: |
            **Not Found**

            This error occurs when the resource does not exist or is not visible by the user.

        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    put:
      tags:
        - TroubleTicket
        - OI
      operationId: updateAnomalieAdresse
      summary: Update a trouble ticket
      description: Update a trouble ticket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    patch:
      tags:
        - TroubleTicket
        - OI
      operationId: partialUpdateAnomalieAdresse
      summary: Partially update a trouble ticket
      description: Partially update a trouble ticket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}/note:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - Note
        - OI
      operationId: getAnomalieAdresseNotes
      summary: Get all notes of a trouble ticket
      description: Get all notes of a trouble ticket
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Note"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Note
        - OI
      operationId: countAnomalieAdresseNotes
      summary: Count the number of notes of a trouble ticket
      description: Count the number of notes of a trouble ticket matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Note
        - OI
      operationId: createAnomalieAdresseNote
      summary: Create a note for a trouble ticket
      description: Create a note for a trouble ticket
      requestBody:
        description: The note to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Note"
      responses:
        "201":
          description: The created note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}/attachment:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - Attachment
        - OI
      operationId: getAnomalieAdresseAttachments
      summary: Get all attachments of a trouble ticket
      description: Get all attachments of a trouble ticket
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Attachment"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Attachment
        - OI
      operationId: countAnomalieAdresseAttachments
      summary: Count the number of attachments of a trouble ticket
      description: Count the number of attachments of a trouble ticket matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Attachment
        - OI
      operationId: createAnomalieAdresseAttachment
      summary: Create an attachment for a trouble ticket
      description: Create an attachment for a trouble ticket
      requestBody:
        description: The attachment to create
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: The file to upload
                attachment:
                  $ref: "#/components/schemas/Attachment"
      responses:
        "201":
          description: The created attachment
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attachment"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        "413":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-413
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}/attachment/{AttachmentId}/content:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"
      - $ref: "#/components/parameters/attachmentId"

    get:
      tags:
        - Attachment
        - OI
      operationId: downloadAnomalieAdresseAttachment
      summary: Download an attachment of a trouble ticket
      description: Download an attachment of a trouble ticket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-None-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Modified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Unmodified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/Range
      responses:
        "200":
          description: The content of the attachment
          content:
            application/octet-stream:
              schema:
                format: binary
                type: string
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412

  /anomalie-adresse/event:
    get:
      tags:
        - Event
        - OI
      operationId: getAnomalieAdresseEvents
      summary: Get all events of all trouble tickets
      description: Get all events of all trouble tickets
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Event
        - OI
      operationId: countAnomalieAdresseEvents
      summary: Count the number of events of all trouble tickets
      description: Count the number of events of all trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Event
        - OC
      operationId: receiveAnomalieAdresseEvent
      summary: Receive an event for a trouble ticket
      description: Receive an event for a trouble ticket
      requestBody:
        description: The event to receive
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        "200":
          description: The event has been received
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        "204":
          description: The event has been received

        default:
          description: |
            L'événement a été reçu avec succès.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        "400": *response400
        "403": *response403
        "404": *response404
        "500":
          description: |
            **Internal Server Error**

            This error occurs when the server encountered an unexpected condition that prevented it from fulfilling the request.

            * The `reason` field of the error response can contain information about the error.
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-500
        "501":
          description: |
            **Not Implemented**

            This error occurs when the server does not support the functionality required to fulfill the request.

            * The `reason` field of the error response can contain information about the error.

components:
  parameters:
    anomalieAdresseId:
      name: AnomalieAdresseId
      in: path
      description: The id of the trouble ticket
      required: true
      schema:
        type: string
        format: uuid
        example: 123e4567-e89b-12d3-a456-426614174000

    attachmentId:
      name: AttachmentId
      in: path
      description: The id of the attachment
      required: true
      schema:
        type: string
        format: uuid
        example: 123e4567-e89b-12d3-a456-426614174000

  schemas:
    AnomalieAdresseBase:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
        - discriminator:
            propertyName: "@type"
            mapping:
              AnomalieAdresse.creation: "#/components/schemas/AnomalieAdresseCreation"
              AnomalieAdresse.newBuilding: "#/components/schemas/AnomalieAdresseNewBuilding"
              AnomalieAdresse.modification: "#/components/schemas/AnomalieAdresseUpdateImb"
              AnomalieAdresse.nbLogements: "#/components/schemas/AnomalieAdresseUpdateNbLogements"
          required:
            - code_oi
            - code_oc
            - "@type"
          properties:
            id:
              type: string
              format: uuid
              readOnly: true
            "@baseType":
              type: string
              default: "AnomalieAdresse"
            "@type":
              type: string
              readOnly: false
              example: AnomalieAdresse.creation
              description: |
                Type de ticket.

                Les valeurs possibles sont:

                * `AnomalieAdresse.creation`: "#/components/schemas/AnomalieAdresseCreation"
                * `AnomalieAdresse.newBuilding`: "#/components/schemas/AnomalieAdresseNewBuilding"
                * `AnomalieAdresse.modification`: "#/components/schemas/AnomalieAdresseUpdateImb"
                * `AnomalieAdresse.nbLogements`: "#/components/schemas/AnomalieAdresseUpdateNbLogements"
            name:
              type: string
              description: Le champ `name` est rempli par l'oi au moment de la création du ticket.
              readOnly: true
            relatedEntity:
              type: object
              description:
                "An entity that is related to the ticket such as a bill,\
                \ a product, etc. The entity against which the ticket is associated.
                \ this property has to be overriden in child classes"
            status:
              description: |
                Le status du ticket.

                Les valeurs possibles sont:

                * `ACKNOWLEDGED`: Le ticket peut être traité par l'OI.

                  Ce status est positionné lorsque la création du ticket est terminée.

                * `IN_PROGRESS`: Qualification du ticket par l'OI (cas simple ou complexe).

                * `PENDING`: Le ticket est en attente d'une action de l'OC.

                  L'OI a besoin d'informations complémentaires pour traiter le ticket.

                * `RESOLVED`: Le ticket est résolu et en attente de validation par l'OC.

                * `CLOSED`: Cloture du ticket par l'OI ou l'OC.

                * `REJECTED`: Le ticket est rejeté par l'OC.

                * `CANCELED`: Le ticket est annulé par l'OC.


                **Notes:**

                * Le changement de status peut être accompagné d'une raison dans `statusChangeReason`.

                * Le changement de status peut être accompagné d'une description dans `statusChangeDetails`.

              default: ACKNOWLEDGED
              enum:
                - ACKNOWLEDGED
                - IN_PROGRESS
                - PENDING
                - RESOLVED
                - CLOSED
                - REJECTED
                - CANCELED
            acknowledgedDuration:
              type: integer
              readOnly: true
              description: Temps cumulé du ticket dans le status `ACKNOWLEDGED`.
            totalInProgressDuration:
              type: integer
              readOnly: true
              description: Temps cumulé du ticket dans le status `IN_PROGRESS`.
            totalPendingDuration:
              type: integer
              readOnly: true
              description: Temps cumulé du ticket dans le status `PENDING`.
            totalDuration:
              type: integer
              readOnly: true
              description: Temps cumulé du ticket dans les status `ACKNOWLEDGED` et `IN_PROGRESS`.
            resolvedToAcknowledgedDuration:
              type: integer
              readOnly: true
              description: Temps cumulé du ticket dans les status `RESOLVED` avant le passage à `ACKNOWLEDGED`.
            resolvedToClosedDuration:
              type: integer
              readOnly: true
              description: Temps cumulé du ticket dans les status `RESOLVED` avant le passage à `CLOSED`.
            expectedResolutionDate:
              description: The expected resolution date
                determined by the trouble ticket system.
              type: string
              format: date-time
              nullable: true
              readOnly: true
            statusChangeReason:
              enum:
                - ALREADY_RESOLVED
                - DELAY_ANSWER_EXPIRED
                - DELAY_VALIDATION_EXPIRED
                - DUPLICATE
                - INFORMATION_PROVIDED
                - INVALID
                - OTHER
                - REQUALIFIED
                - RESOLUTION_ACCEPTED
                - RESOLUTION_REFUSED
                - RESOLVED
                - UNKNOWN_RESOURCE
                - UNKNOWN_ZONE
                - UNRESOLVABLE
                - WAITING_INFORMATION
            priority:
              readOnly: false
              type: string
              enum:
                - LOW
                - MEDIUM
                - HIGH
              default: LOW
            complexity:
              type: string
              readOnly: true
              enum:
                - SIMPLE
                - COMPLEX
                - MASSE
              description: |
                Complexité du ticket.
                La valeur est renseignée par l'OI lors du passage à l'état `IN_PROGRESS`.

                Les valeurs possibles sont:

                * `SIMPLE`: cas ne nécessitant pas d'intervention sur le terrain,
                  pas d'intervention sur le réseau ou de réalignement de référentiels.
                * `COMPLEX`: cas qui n'est pas un cas simple.
                * `MASSE`: cas qui concerne les anomalies en masse.
            code_oi: # Code ARCEP de l'OI.
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep

            code_oc: # Code ARCEP de l'OC.
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
            externalId:
              description: Référence interne du ticket de l'OC.
              type: string
            ticketType:
              description: |
                Types de ticket.

                Les valeurs possibles sont:

                * `CUSTOMER_REQUEST`: Ticket créé par l'OC suite à une demande client final
                  qui souhaite passer commande.
                * `OC_REQUEST`: Ticket créé par l'OC sans demande client final.

                La valeur est renseignée par l'OC à la création du ticket.
              default: OC_REQUEST
              enum:
                - OC_REQUEST
                - CUSTOMER_REQUEST
            siren:
              type: string
              description: Numéro SIREN de l'entreprise cliente.
            siret:
              type: string
              description: Numéro SIRET de l'entreprise cliente.
            zone:
              type: string
              enum:
                - ZTD
                - ZMD
              readOnly: true
              description: |
                Zone de traitement du ticket.

                La valeur est renseignée par l'OI lors de la qualification du ticket
                et du passage au status `IN_PROGRESS`.

    AnomalieAdresseCreation:
      description: |
        *AnomalieAdresseCreation* permet la création d'une adresse inexistante dans l'IPE
        ou d'une immeuble neuf.

        Dans la mesure du possible, l'OC doit fournir les informations suivantes:

        * Quadrulet (`code_rivoli`, `code_insee`, `streetNr`, `streetNrSuffix`)
        * `code_hexacle`
        * `code_ban`
        * N-uplet (`postcode`, `city`, `streetName`)

        Pour les immeubles neufs, l'OC peut fournir les informations suivantes
        sur le bailleur et le promoteur immobilier grâce aux champs `realEstateLessor` et `realEstateDeveloper`.

      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
        - required:
            - building
          properties:
            relatedEntity:
              type: array
              items:
                $ref: "#/components/schemas/RelatedBuilding"
            building:
              $ref: "#/components/schemas/AnomalieAdresseCreationBuilding"

    AnomalieAdresseCreationBuilding:
      allOf:
        - $ref: "#/components/schemas/Building"
      required:
        - address
        - geographicLocation
        - newConstruction
        - type

    AnomalieAdresseNewBuilding:
      description: |
        *AnomalieAdresseNewBuilding* permet de rajouter un nouveau bâtiment à une adresse existante dans l'IPE.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
        - required:
            - building
            - relatedEntity
          properties:
            relatedEntity:
              type: array
              minItems: 1
              maxItems: 1
              items:
                $ref: "#/components/schemas/RelatedBuilding"
            building:
              $ref: "#/components/schemas/AnomalieAdresseNewBuildingBuilding"

    AnomalieAdresseNewBuildingBuilding:
      allOf:
        - $ref: "#/components/schemas/Building"
        - required:
            - name
            - geographicLocation
            - newConstruction
            - type

    AnomalieAdresseUpdate:
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
        - properties:
            "@baseType":
              type: string
              default: "AnomalieAdresseUpdate"
            sizeRefs:
              type: integer
              description: |
                Nombre d'immeubles cibles de l'anomalie.

                La valeur est renseignée par l'OI à la création du ticket.
                Elle est égale à la taille du tableau `relatedEntity`.
                Elle permet de rechercher plus efficacement les anomalies
                et de facilement différencier les traitement unitaires et en masse.
              readOnly: true

    AnomalieAdresseUpdateImb:
      description: |
        *AnomalieAdresseUpdateImb* est une anomalie de type `AnomalieAdresseUpdate`
        qui permet de mettre à jour un des attributs en masse d'un ou plusieurs immeubles.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseUpdate"
        - required:
            - issues
            - relatedEntity
          properties:
            relatedEntity:
              description: |
                Liste des immeubles cibles de l'anomalie.

                Si cette liste est supérieure à 1, alors l'OI traite les cas possibles de la demande en masse
                et demande la résolution du ticket.
                L'OC pourra rouvrir un ticket unitaire si besoin pour chaque cas non résolus.
              type: array
              minItems: 1
              items:
                $ref: "#/components/schemas/RelatedBuilding"
            issues:
              $ref: "#/components/schemas/AnomalieAdresseUpdateImbIssues"

    AnomalieAdresseUpdateImbIssues:
      description: "Les anomalies spécifiques en masse"
      type: object
      properties:
        "building.geographicLocations":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingGeographicLocations"
        "building.name":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingName"
        "building.address.city":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingCity"
        "building.address.postcode":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingPostcode"
        "building.address.streetName":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingStreetName"
        "building.address.streetNr":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingStreetNr"
        "building.address.streetNrSuffix":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingStreetNrSuffix"
        "building.address.streetType":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingStreetType"
        "building.address.code_insee":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingCodeInsee"
        "building.address.code_hexacle":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingCodeHexacle"
        "building.address.code_hexacle_voie":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingCodeHexacleVoie"
        "building.address.code_rivoli":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingCodeRivoli"
        "building.address.code_ban":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingCodeBan"
        "building.pm.id":
          $ref: "#/components/schemas/UpdateImbIssuesBuildingPmId"

    UpdateImbIssuesBuildingGeographicLocations:
      type: object
      description: Liste des coordonnées géographiques de l'adresse corrigée.
      properties:
        value:
          type: array
          items:
            $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/GeographicPoint

    UpdateImbIssuesBuildingName:
      type: object
      description: |
        Nom du bâtiment.

        Ce champ est nommé `BatimentImmeuble` dans le fichier IPE.
      properties:
        value:
          type: array
          items:
            $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/Building/allOf/1/properties/name
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.
            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.
    UpdateImbIssuesBuildingCity:
      type: object
      description: |
        Nom de la commune.

        Ce champ est nommé `CommuneImmeuble` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/city

    UpdateImbIssuesBuildingPostcode:
      type: object
      description: |
        Code postal.

        Ce champ est nommé `CodePostalImmeuble` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/postcode

    UpdateImbIssuesBuildingStreetName:
      type: object
      description: |
        Nom de la voie.

        Ce champ est nommé `NomVoieImmeuble` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetName
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingStreetNr:
      type: object
      description: |
        Numéro de la voie.

        Ce champ est nommé `NumeroVoieImmeuble` dans le fichier IPE.
      properties:
        value:
          type: array
          items:
            $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetNr
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingStreetNrSuffix:
      type: object
      description: |
        Complément du numéro de la voie.

        Ce champ est nommé `ComplementNumeroVoieImmeuble` dans le fichier IPE.
      properties:
        value:
          type: array
          items:
            $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetNrSuffix
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingStreetType:
      type: object
      description: |
        Type de la voie.

        Ce champ est nommé `TypeVoieImmeuble` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetType
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingCodeInsee:
      type: object
      description: |
        Code INSEE de la commune.

        Ce champ est nommé `CodeInseeImmeuble` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_insee

    UpdateImbIssuesBuildingCodeHexacle:
      type: object
      description: |
        Code Hexacle de la commune.

        Ce champ est nommé `CodeAdresseImmeuble` dans le fichier IPE.
      properties:
        value:
          type: array
          items:
            $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_hexacle
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingCodeHexacleVoie:
      type: object
      description: |
        Code Hexacle de la voie.

        Ce champ est nommé `CodeHexacleVoie` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_hexacle_voie
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingCodeRivoli:
      type: object
      description: |
        Code Rivoli de la commune.

        Ce champ est nommé `CodeVoieRivoliImmeuble` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_rivoli
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingCodeBan:
      type: object
      description: |
        Code BAN de l'immeuble.

        Ce champ est nommé `CodeBAN` dans le fichier IPE.
      properties:
        value:
          type: array
          items:
            $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_ban
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    UpdateImbIssuesBuildingPmId:
      type: object
      description: |
        Identifiant du PM associé à l'immeuble.

        Ce champ est nommé `ReferencePM` dans le fichier IPE.
      properties:
        value:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PM/properties/id

    AnomalieAdresseUpdateNbLogements:
      description: |
        *AnomalieAdresseUpdateNbLogements* est une anomalie de type `AnomalieAdresseUpdate`
        qui permet de mettre à jour le nombre de logements cibles d'un immeuble.

        Cette anomalie est unitaire et ne peut contenir qu'un seul immeuble.

        Cette anomalie ne peut contenir qu'une seule correction dont la clé vaut `building.housingsNumber`.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseUpdate"
        - required:
            - issues
            - relatedEntity
          properties:
            relatedEntity:
              description: |
                Liste des immeubles cibles de l'anomalie.

                Si cette liste est supérieure à 1, alors l'OI traite les cas possibles de la demande en masse
                et demande la résolution du ticket.
                L'OC pourra rouvrir un ticket unitaire si besoin pour chaque cas non résolus.
              type: array
              minItems: 1
              maxItems: 1
              items:
                $ref: "#/components/schemas/RelatedBuilding"
            issues:
              $ref: "#/components/schemas/AnomalieAdresseUpdateNbLogementsIssues"

    AnomalieAdresseUpdateNbLogementsIssues:
      type: object
      description: "Les issues relatives à la mise à jour du nombre de logements d'un immeuble."
      required:
        - "building.housingsNumber"
      properties:
        "building.housingsNumber":
          required:
            - value
          properties:
            value:
              type: integer
              minimum: 0
          description: |
            Nombre de logement de l'immeuble.

            Ce champ est nommé `NombreLogementsAdresseIPE` dans le fichier IPE.

    Building:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/Building
        - properties:
            id:
              description: |
                Identifiant unique de l'immeuble.

                La valeur est renseignée par l'OI à la résolution du ticket.
              type: string
              readOnly: true
            neighbor:
              $ref: "#/components/schemas/RelatedBuilding"
            realEstateDeveloper: # Promoteur immobilier
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Company.openapi.yaml#/components/schemas/Company
            realEstateLessor: # Bailleur
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Company.openapi.yaml#/components/schemas/Company
            plot:
              description: Parcelle cadastrale.
              type: string
              pattern: ^[0-9A-Z]+$
            newConstruction:
              description: Indique si le bâtiment est neuf.
              type: boolean

    Note:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Note.openapi.yaml#/components/schemas/Note
        - properties:
            relatedEntity:
              description: |
                Relation entre la note et l'anomalie.
                Ce champ est renseigné par l'OI lors de la création de la note.
              type: array
              minItems: 1
              maxItems: 1
              readOnly: true
              items:
                $ref: "#/components/schemas/RelatedAnomalie"

    Attachment:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Attachment.openapi.yaml#/components/schemas/AttachmentBase
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Attachment.openapi.yaml#/components/schemas/AttachmentMonoPart
        - description: |
            An attachment is a file that is attached to an entity.

            Les extensions de fichier autorisées sont:

            * `csv`
            * `jpeg`
            * `jpg`
            * `png`
            * `svg`
            * `pdf`
            * `ods`
            * `odt`
            * `xlsx`
            * `docx`

            Les fichiers contenant du code exécutable comme des scripts ou des macros sont interdits.
          properties:
            mimeType:
              enum:
                - text/csv
                - image/jpeg
                - image/png
                - image/svg+xml
                - application/pdf
                - application/vnd.oasis.opendocument.spreadsheet
                - application/vnd.oasis.opendocument.text
                - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
                - application/vnd.openxmlformats-officedocument.wordprocessingml.document
            relatedEntity:
              description: |
                Relation entre l'attachment et l'anomalie.
                Ce champ est renseigné par l'OI lors de la création de l'attachment.
              type: array
              minItems: 1
              maxItems: 1
              readOnly: true
              items:
                $ref: "#/components/schemas/RelatedAnomalie"

    Event:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/CloudEvent.openapi.yaml#/components/schemas/CloudEvent
        - discriminator:
            propertyName: type
            mapping:
              fr.interop.anomalieadresse.update: "#/components/schemas/EventAnomalieAdresse"
              fr.interop.anomalieadresse.note.create: "#/components/schemas/EventAnomalieAdresseNote"
              fr.interop.anomalieadresse.attachment.create: "#/components/schemas/EventAnomalieAdresseAttachmentCreation"
              fr.interop.anomalieadresse.attachment.update: "#/components/schemas/EventAnomalieAdresseAttachmentUpdate"
          required:
            - time
            - subject
            - type
          properties:
            subject:
              description: Identifiant unique de l'anomalie.
              type: string
              format: uuid
            type:
              type: string
            datacontenttype:
              type: string
              default: "application/json"
              example: "application/json"

    EventAnomalieAdresse:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/AnomalieAdresseBase"

    EventAnomalieAdresseNote:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/Note"

    EventAnomalieAdresseAttachmentCreation:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/Attachment"

    EventAnomalieAdresseAttachmentUpdate:
      allOf:
        - $ref: "#/components/schemas/Event"
        - properties:
            data:
              $ref: "#/components/schemas/Attachment"

    RelatedBuilding:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
        - properties:
            "@referredType":
              type: string
              default: "Building"
            role:
              type: string
              default: "building"

    RelatedAnomalie:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
        - properties:
            "@referredType":
              type: string
              default: "AnomalieAdresse"
            role:
              type: string
              default: "anomalie"
            id:
              description: Identifiant unique de l'anomalie.
              type: string
