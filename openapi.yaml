openapi: 3.1.0

info:
  title: AnomalieAdresse API
  version: 2.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
    identifier: Apache-2.0
  description: |
    Cet outil a été créé afin de respecter l'obligation réglementaire
    indiquée dans la [Décision Arcep n° 2020-1432].

    Il permet le traitement d'une demande de création ou de modification d'adresses
    dans les IPE grâce à des flux normalisés.

    **Extrait de la [Décision Arcep n° 2020-1432]:**

      *«
      Compte tenu de l'importance des fichiers IPE qui permettent de connaître l'éligibilité sur les réseaux FttH,
      il apparaît raisonnable d'imposer aux opérateurs d'infrastructure la mise en place d'un processus inter-opérateurs
      afin de permettre aux opérateurs commerciaux de leur signaler ces immeubles manquants ou erronés.
      Comme pour les autres processus inter-opérateurs, il serait souhaitable qu'un tel processus de signalement
      soit identique chez l'ensemble des opérateurs d'infrastructure
      afin de permettre aux opérateurs commerciaux de mutualiser les développements nécessaires.
      »*

    ## Lexique

    #### OI

    **Opérateur d'immeuble**:
    Toute personne chargée de l'établissement ou de la gestion d'une ou plusieurs lignes dans un immeuble bâti,
    notamment dans le cadre d'une convention d'installation, d'entretien, de remplacement ou de gestion
    des lignes signée avec le propriétaire ou le syndicat de copropriétaires,
    en application de l'article [L33-6] du code des postes et des communications électroniques;
    l'opérateur d'immeuble n'est pas nécessairement un opérateur au sens de l'article [L33-1] du même code.

    #### OC

    **Opérateur Commercial**:
    Opérateur choisi par le client final pour la fourniture d'un service de télécommunications
    ou par un fournisseur d'accès au service pour la fourniture d'un service de télécommunications
    à son propre client final.

    ## Processus

    Les délais de traitement sont fixés par typologie dans la [Décision Arcep n° 2020-1432]:

    * Dans le cas d'un signalement unitaire, la correction de l'IPE par l'OI devra intervenir
      dans un délai d'une semaine après le signalement de l'OC pour les cas simples
      et de trois semaines maximum pour les cas complexes.

    * Dans le cas d'un signalement en masse, la correction de l'IPE par l'OI devra intervenir
      dans un délai de 2 mois maximum après le signalement de l'OC.

    Le processus doit prendre en compte deux catégories de signalements des anomalies de référencement d'adresses:

    * **Signalement unitaire**:
      par exemple anomalie détectée à partir d'une réclamation client.
      Il s'agit d'un signalement impactant une seule ligne de l'building.

    * **Signalement en masse**:
      par exemple liste d'anomalies détectées par contrôles informatisés ayant un critère commun (anomalie sur un même champ).
      Il s'agit d'un signalement unitaire impactant deux lignes IPE ou plus.
      Certains critères devront concerner la même zone géographique.

      La liste des critères communs n'est pas fermée et pourra être complétée
      à la demande d'un opérateur suite à la validation par consensus du groupe de travail Infrastructure.

    ## Types de signalement

    ![Types de signalement](./type.drawio.svg)

    ### AnomalieAdresseUpdate

    * **AnomalieAdresse.modification**

      Anomalie qui permet de mettre à jour un ou plusieurs attributs sur un ou plusieurs immeubles.

    * **AnomalieAdresse.nbLogements**

      Anomalie qui permet de mettre à jour le nombre de logements cible d'un immeuble.

    ### AnomalieAdresseCreation

    * **AnomalieAdresse.creation**

      Création d'une adresse inexistante dans l'IPE ou d'un immeuble neuf.

    * **AnomalieAdresse.batiment**

      Rajout d'un bâtiment à une adresse existante dans l'IPE.

    ## Workflow

    ![Workflow](./status.drawio.svg)

    **Possibilités de changement de status:**


    * `ACKNOWLEDGED` → `REJECTED`: Le ticket n'est pas recevable.

      **Ce changement de status ne peut être effectué que par l'OI.**

      Les raisons (`statusChangeReason`) possibles sont:

      * `UNKNOWN_RESOURCE`: la ressource n'existe pas chez l'OI

      * `UNKNOWN_ZONE`: la zone géographique n'est pas couverte par l'OI

      * `DUPLICATE`: le ticket est en conflit avec un autre ticket (2 demandes actives sur la même adresse)

        Le champ `statusChangeDetails` est obligatoire avec la référence du ou des tickets en conflit.

      * `ALREADY_RESOLVED`: la resource existe déjà chez l'OI

        Le champ `statusChangeDetails` est obligatoire avec la référence de la ressource existante.

      * `INVALID`: le ticket est invalide (champ manquant, valeur incorrecte, etc.)

        Le champ `statusChangeDetails` est obligatoire.

      * `OTHER`: autre raison non référencée par le protocole.

        Le champ `statusChangeDetails` est obligatoire.

      L'OI doit fournir la durée d'analyse dans le champ `acknowledgedDuration`.


    * `ACKNOWLEDGED` → `IN_PROGRESS`: Le ticket est recevable.

      **Ce changement de status ne peut être effectué que par l'OI.**

      Le temps de traitement est décompté à partir de ce changement de status (`totalInProgressDuration`).

      L'OI doit renseigner:

      * Une date de résolution prévisionnelle dans le champ `expectedResolutionDate`
        (même si cette date est antérieure à la date courante).

      * Le qualification du ticket dans le champ `complexity`.

      * La durée d'analyse dans le champ `acknowledgedDuration`.


    * `IN_PROGRESS` → `PENDING`: demande d'information complémentaire

      **Ce changement de status ne peut être effectué que par l'OI.**

      Le temps de traitement est suspendu à partir de ce changement de status.

      Le champ `statusChangeReason` doit être renseigné avec la valeur `WAITING_INFORMATION`.

      L'OC doit fournir en retour:

      * La liste des informations complémentaires attendues dans le champ `statusChangeDetails`.

        Ces informations peuvent être fournies dans une note ou un attachement.


    * `IN_PROGRESS` → `IN_PROGRESS`: requalification du ticket.

      **Ce changement de status ne peut être effectué que par l'OI.**

      L'OI doit renseigner:

      * La nouvelle qualification du ticket dans le champ `complexity`.

      * La date de résolution prévisionnelle dans le champ `expectedResolutionDate`.

      * Le champ `statusChangeDetails` doit être renseigné avec la raison de la requalification.

      * Le champ `statusChangeReason` doit être renseigné avec la valeur `REQUALIFIED`.


    * `IN_PROGRESS` → `RESOLVED`: résolution du ticket

      **Ce changement de status ne peut être effectué que par l'OI.**

      L'OI doit renseigner:

      * La durée de résolution dans le champ `totalInProgressDuration`.

      * Pour les création, la référence de la ressource créée ou modifiée dans le champ `building.id`.

      L'OC peut accepter la résolution du ticket en passant le status à `CLOSED`
      ou la refuser en passant le status à `IN_PROGRESS`.

      Le temps de traitement est suspendu à partir de ce changement de status.


    * `PENDING` → `IN_PROGRESS`: réponse à une demande d'information complémentaire

      **Ce changement de status ne peut être effectué que par l'OC.**

      Le temps de traitement est repris à partir de ce changement de status.

      L'OI doit renseigner:

      * La durée de gel dans le champ `totalPendingDuration`.


    * `PENDING` → `RESOLVED`: annulation du ticket

      **Ce changement de status ne peut être effectué que par l'OI.**

      Le ticket est annulé car l'OC n'a pas répondu à la demande d'information complémentaire
      dans les délais impartis. *Ce délai est à la disposition de l'OI*.

      Le champ `statusChangeReason` doit être renseigné avec la valeur `DELAY_ANSWER_EXPIRED`.


    * `RESOLVED` → `CLOSED`: validation de la résolution du ticket.

      **Ce changement de status ne peut être effectué que par l'OC ou l'OI.**

      Le ticket est clos.

      * Si ce changement est effectué par l'OC, le ticket est clos par validation de la résolution.

        Le champ `statusChangeReason` doit être renseigné avec la valeur `RESOLUTION_ACCEPTED`.

      * Si le changement est effectué par l'OI, le ticket est clos
        car l'OC n'a pas répondu à la résolution dans les délais impartis.
        *Ce délai est à la disposition de l'OI*.

        Le champ `statusChangeReason` doit être renseigné avec la valeur `DELAY_VALIDATION_EXPIRED`.

        L'OI doit renseigner:

        * La durée de gel dans le champ `totalPendingDuration`.

    * `RESOLVED` → `IN_PROGRESS`: refus de la résolution du ticket.

      **Ce changement de status ne peut être effectué que par l'OC.**

      La résolution du ticket est refusée par l'OC.

      * Le champ `statusChangeReason` doit être renseigné avec la valeur `RESOLUTION_REFUSED`.
      * Le champ `statusChangeDetails` doit être renseigné avec la raison du refus.

      Le temps de traitement est repris à partir de ce changement de status.

    * `ACKNOWLEDGED|IN_PROGRESS|PENDING` → `CANCELED`: annulation du ticket par l'OC.

      **Ce changement de status ne peut être effectué que par l'OC.**

      Le ticket est annulé par l'OC.

      Le temps de traitement est annulé à partir de ce changement de status.

      * Le champ `statusChangeDetails` doit être renseigné avec la raison de l'annulation.


    ## Pagination

    Les listes de ressources sont paginées.

    * La valeur par défaut d'une page est `limit=50` et `offset=0`.
    * La valeur maximale de `limit` est `100`.

    ## Délais de traitement

    Les délais de traitement sont fixés par typologie:

    * cas simple: 1 semaine
    * cas complexe: 3 semaines
    * signalement en masse: 8 semaines


    ## Dépendances

    Cette API utilise une architecture proxyfié pour la gestion des dépendances.

    ![Proxyfied architecture schema](https://raw.githubusercontent.com/before-interop/common/main/schema/architecture.drawio.svg)

    * [TroubleTicket](https://ggrebert.github.io/before-interop-common/?urls.primaryName=TroubleTicket)
    * [Attachment](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Attachment)
    * [Note](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Note)
    * [Event](https://ggrebert.github.io/before-interop-common/?urls.primaryName=Event)


    [Décision Arcep n° 2020-1432]: https://www.arcep.fr/uploads/tx_gsavis/20-1432.pdf
    [L33-1]: https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000047293234
    [L33-6]: https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000037671945

servers:
  - url: "{protocol}://{host}:{port}{basePath}/anomalie-adresse"
    variables:
      protocol:
        enum:
          - https
          - http
        default: https
      host:
        default: localhost
      port:
        default: "8080"
      basePath:
        default: /api/v2

tags:
  - name: TroubleTicket
    description: TroubleTicket management
  - name: Note
    description: Note management
  - name: Attachment
    description: Attachment management
  - name: Event
    description: Event management
  - name: OI
    description: OI endpoints
  - name: OC
    description: OC endpoints

paths:
  /:
    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get all trouble tickets
      description: Get all trouble tickets
      parameters: &searchAndPaginateParameters
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/limit
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/offset
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/parameters/sort
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/fields.openapi.yaml#/components/parameters/fields
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The list of trouble tickets
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AnyOfAnomalieAdresse"
        "400": &response400
          description: |
            **Bad Request**

            This error occurs when a query parameter or the body is invalid.

            * The `reason` field of the error response can contain information about the error.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

    head:
      tags:
        - TroubleTicket
        - OI
      summary: Count the number of trouble tickets
      description: Count the number of trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of trouble tickets.
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

    post:
      tags:
        - TroubleTicket
        - OI
      summary: Create a trouble ticket
      description: Create a trouble ticket
      requestBody:
        description: The trouble ticket to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OneOfAnomalieAdresse"
      responses:
        "201": &troubleTicket201
          description: The trouble ticket
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OneOfAnomalieAdresse"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "403": &response403
          description: |
            **Forbidden**

            Le serveur a compris la requête, mais refuse de l'exécuter car le client n'a pas respecté le processus de création ou de mise à jour.

            Exemple: passage du status `ACKNOWLEDGED` à `RESOLVED` sans passer par le status `IN_PROGRESS`.

            * Le champ `reason` de la réponse d'erreur doit contenir la liste des tickets en conflit séparés par des virgules.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

  /{AnomalieAdresseId}:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - TroubleTicket
        - OI
      summary: Get a trouble ticket
      description: Get a trouble ticket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/fields.openapi.yaml#/components/parameters/fields
      responses:
        "200":
          description: The trouble ticket
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OneOfAnomalieAdresse"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "404": &response404
          description: |
            **Not Found**

            This error occurs when the resource does not exist or is not visible by the user.
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Error.openapi.yaml#/components/schemas/Error

    put:
      tags:
        - TroubleTicket
        - OI
      summary: Update a trouble ticket
      description: Update a trouble ticket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OneOfAnomalieAdresse"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    patch:
      tags:
        - TroubleTicket
        - OI
      summary: Partially update a trouble ticket
      description: Partially update a trouble ticket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OneOfAnomalieAdresse"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{AnomalieAdresseId}/note:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - Note
        - OI
      summary: Get all notes of a trouble ticket
      description: Get all notes of a trouble ticket
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Note"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Note
        - OI
      summary: Count the number of notes of a trouble ticket
      description: Count the number of notes of a trouble ticket matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Note
        - OI
      summary: Create a note for a trouble ticket
      description: Create a note for a trouble ticket
      requestBody:
        description: The note to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Note"
      responses:
        "201":
          description: The created note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Note"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{AnomalieAdresseId}/attachment:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - Attachment
        - OI
      summary: Get all attachments of a trouble ticket
      description: Get all attachments of a trouble ticket
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Attachment"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Attachment
        - OI
      summary: Count the number of attachments of a trouble ticket
      description: Count the number of attachments of a trouble ticket matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Attachment
        - OI
      summary: Create an attachment for a trouble ticket
      description: Create an attachment for a trouble ticket
      requestBody:
        description: The attachment to create
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/AttachmentFormData"
      responses:
        "201":
          description: The created attachment
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Attachment"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

  /{AnomalieAdresseId}/attachment/{AttachmentId}/content:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"
      - $ref: "#/components/parameters/attachmentId"

    get:
      tags:
        - Attachment
        - OI
      summary: Download an attachment of a trouble ticket
      description: Download an attachment of a trouble ticket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-None-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Modified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Unmodified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/parameters/Range
      responses:
        "200":
          description: The content of the attachment
          content:
            application/octet-stream: {}
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/Error-412

  /event:
    get:
      tags:
        - Event
        - OI
      summary: Get all events of all trouble tickets
      description: Get all events of all trouble tickets
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Event"
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Event
        - OI
      summary: Count the number of events of all trouble tickets
      description: Count the number of events of all trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Event
        - OC
      summary: Receive an event for a trouble ticket
      description: Receive an event for a trouble ticket
      requestBody:
        description: The event to receive
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        default:
          description: |
            L'événement a été reçu avec succès.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        4xx:
          description: |
            Erreur lors de la réception de l'événement.

            L'OI ne doit pas retransmettre l'événement à l'OC.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        5xx:
          description: |
            Erreur lors de la réception de l'événement.

            L'OI peut retransmettre l'événement à l'OC.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.

components:
  parameters:
    anomalieAdresseId:
      name: AnomalieAdresseId
      in: path
      description: The id of the trouble ticket
      required: true
      schema:
        type: string
        format: uuid
        example: 123e4567-e89b-12d3-a456-426614174000

    attachmentId:
      name: AttachmentId
      in: path
      description: The id of the attachment
      required: true
      schema:
        type: string
        format: uuid
        example: 123e4567-e89b-12d3-a456-426614174000

  schemas:
    OneOfAnomalieAdresse:
      oneOf:
        - $ref: "#/components/schemas/AnomalieAdresseCreation"
        - $ref: "#/components/schemas/AnomalieAdresseNewBuilding"
        - $ref: "#/components/schemas/AnomalieAdresseUpdateImb"
        - $ref: "#/components/schemas/AnomalieAdresseUpdateNbLogements"
      discriminator:
        propertyName: "@type"
        mapping:
          AnomalieAdresseCreation: "#/components/schemas/AnomalieAdresseCreation"
          AnomalieAdresseNewBuilding: "#/components/schemas/AnomalieAdresseNewBuilding"
          AnomalieAdresse.modification: "#/components/schemas/AnomalieAdresseUpdateImb"
          AnomalieAdresse.nbLogements: "#/components/schemas/AnomalieAdresseUpdateNbLogements"

    AnyOfAnomalieAdresse:
      anyOf:
        - $ref: "#/components/schemas/AnomalieAdresseCreation"
        - $ref: "#/components/schemas/AnomalieAdresseNewBuilding"
        - $ref: "#/components/schemas/AnomalieAdresseUpdateImb"
        - $ref: "#/components/schemas/AnomalieAdresseUpdateNbLogements"
      discriminator:
        propertyName: "@type"
        mapping:
          AnomalieAdresseCreation: "#/components/schemas/AnomalieAdresseCreation"
          AnomalieAdresseNewBuilding: "#/components/schemas/AnomalieAdresseNewBuilding"
          AnomalieAdresse.modification: "#/components/schemas/AnomalieAdresseUpdateImb"
          AnomalieAdresse.nbLogements: "#/components/schemas/AnomalieAdresseUpdateNbLogements"

    AnomalieAdresseBase:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
      required:
        - code_oi
        - code_oc
        - "@type"
      properties:
        "@baseType":
          const: AnomalieAdresse
        "@type":
          type: string
          readOnly: false
        status:
          description: |
            Le status du ticket.

            Les valeurs possibles sont:

            * `ACKNOWLEDGED`: Le ticket peut être traité par l'OI.

              Ce status est positionné lorsque la création du ticket est terminée.

            * `IN_PROGRESS`: Qualification du ticket par l'OI (cas simple ou complexe).

            * `PENDING`: Le ticket est en attente d'une action de l'OC.

              L'OI a besoin d'informations complémentaires pour traiter le ticket.

            * `RESOLVED`: Le ticket est résolu et en attente de validation par l'OC.

            * `CLOSED`: Cloture du ticket par l'OI ou l'OC.

            * `REJECTED`: Le ticket est rejeté par l'OC.

            * `CANCELED`: Le ticket est annulé par l'OC.


            **Notes:**

            * Le changement de status peut être accompagné d'une raison dans `statusChangeReason`.

            * Le changement de status peut être accompagné d'une description dans `statusChangeDetails`.

          default: ACKNOWLEDGED
          enum:
            - ACKNOWLEDGED
            - IN_PROGRESS
            - PENDING
            - RESOLVED
            - CLOSED
            - REJECTED
            - CANCELED
        expectedResolutionDate:
          description: Date prévisionnelle de résolution du ticket.
            La valeur est renseignée par l'OI lors du passage à l'état `IN_PROGRESS`.
        acknowledgedDuration:
          type: integer
          readOnly: true
          description: Temps passé du ticket dans le status `ACKNOWLEDGED`.
        totalInProgressDuration:
          type: integer
          readOnly: true
          description: Temps cumulé du ticket dans le status `IN_PROGRESS`.
        totalPendingDuration:
          type: integer
          readOnly: true
          description: Temps cumulé du ticket dans le status `PENDING`.
        totalDuration:
          type: integer
          readOnly: true
          description: Temps cumulé du ticket dans les status `ACKNOWLEDGED` et `IN_PROGRESS`.
        resolvedToInProgressDuration:
          type: integer
          readOnly: true
          description: Temps du ticket dans les status `RESOLVED` avant le passage à `IN_PROGRESS`.
        resolvedToClosedDuration:
          type: integer
          readOnly: true
          description: Temps du ticket dans les status `RESOLVED` avant le passage à `CLOSED`.
        statusChangeReason:
          enum:
            - ALREADY_RESOLVED
            - DELAY_ANSWER_EXPIRED
            - DELAY_CREATION_EXPIRED
            - DELAY_VALIDATION_EXPIRED
            - DUPLICATE
            - INVALID
            - OTHER
            - RESOLUTION_ACCEPTED
            - UNKNOWN_RESOURCE
            - UNKNOWN_ZONE
            - PASSED_TO_INPROGRESS
            - WAITING_INFORMATION
        priority:
          readOnly: false
          enum:
            - LOW
            - MEDIUM
            - HIGH
          default: LOW
        complexity:
          type: string
          readOnly: true
          enum:
            - SIMPLE
            - COMPLEX
          description: |
            Complexité du ticket.
            La valeur est renseignée par l'OI lors du passage à l'état `IN_PROGRESS`.

            Les valeurs possibles sont:

            * `SIMPLE`: cas ne nécessitant pas d'intervention sur le terrain,
              pas d'intervention sur le réseau ou de réalignement de référentiels.
            * `COMPLEX`: cas qui n'est pas un cas simple
        code_oi:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
          description: Code ARCEP de l'OI.

            La valeur est renseignée par l'OC à la création du ticket.
        code_oc:
          $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/CodeOperateurArcep
          description: Code ARCEP de l'OC.

            La valeur est renseignée par l'OC à la création du ticket.
        externalId:
          description: Référence interne du ticket de l'OC.
        ticketType:
          description: |
            Types de ticket.

            Les valeurs possibles sont:

            * `CUSTOMER_REQUEST`: Ticket créé par l'OC suite à une demande client final
              qui souhaite passer commande.
            * `OC_REQUEST`: Ticket créé par l'OC sans demande client final.

            La valeur est renseignée par l'OC à la création du ticket.
          default: OC_REQUEST
          enum:
            - OC_REQUEST
            - CUSTOMER_REQUEST
        siren:
          type: string
          description: Numéro SIREN de l'entreprise cliente.
        siret:
          type: string
          description: Numéro SIRET de l'entreprise cliente.

    AnomalieAdresseCreation:
      description: |
        *AnomalieAdresseCreation* permet la création d'une adresse inexistante dans l'IPE
        ou d'une immeuble neuf.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
      required:
        - building
      properties:
        "@type":
          const: AnomalieAdresse.creation
        building:
          allOf:
            - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/Building
          required:
            - address
            - geographicLocation
            - relatedEntity
          properties:
            neighbor:
              allOf:
                - $ref: "#/components/schemas/RelatedBuilding"
            id:
              description: |
                Identifiant unique de l'immeuble.

                La valeur est renseignée par l'OI à la résolution du ticket.
              readOnly: true
            address:
              required:
                - city
                - postcode
                - code_insee
            realEstateDeveloper:
              description: Promoteur immobilier.
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Company.openapi.yaml#/components/schemas/Company
            realEstateLessor:
              description: Bailleur.
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Company.openapi.yaml#/components/schemas/Company
            newConstruction:
              type: boolean

    AnomalieAdresseNewBuilding:
      description: |
        *AnomalieAdresseNewBuilding* permet de rajouter un nouveau bâtiment à une adresse existante dans l'IPE.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
      required:
        - building
      properties:
        "@type":
          const: AnomalieAdresse.batiment
        neighbor:
          allOf:
            - $ref: "#/components/schemas/RelatedBuilding"
        relatedEntity:
          type: array
          minItems: 1
          maxItems: 1
          items:
            $ref: "#/components/schemas/RelatedBuilding"
        building:
          allOf:
            - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/Building
          required:
            - name
            - geographicLocation
          properties:
            id:
              description: |
                Identifiant unique de l'immeuble.

                La valeur est renseignée par l'OI à la résolution du ticket.
              readOnly: true
            realEstateDeveloper:
              description: Promoteur immobilier.
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Company.openapi.yaml#/components/schemas/Company
            realEstateLessor:
              description: Bailleur.
              $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Company.openapi.yaml#/components/schemas/Company
            newConstruction:
              type: boolean

    AnomalieAdresseUpdate:
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
      required:
        - issues
        - relatedEntity
      properties:
        "@baseType":
          enum:
            - AnomalieAdresseUpdate
        relatedEntity:
          type: array
          minItems: 1
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedBuilding"
        sizeRefs:
          type: integer
          description: |
            Nombre d'immeubles cibles de l'anomalie.

            La valeur est renseignée par l'OI à la création du ticket.
            Elle est égale à la taille du tableau `relatedEntity`.
            Elle permet de rechercher plus efficacement les anomalies
            et de facilement différencier les traitement unitaires et en masse.
          readOnly: true
        issues:
          type: object

    AnomalieAdresseUpdateImb:
      description: |
        *AnomalieAdresseUpdateImb* est une anomalie de type `AnomalieAdresseUpdate`
        qui permet de mettre à jour un des attributs en masse d'un ou plusieurs immeubles.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseUpdate"
      properties:
        "@type":
          const: AnomalieAdresse.modification
        issues:
          properties:
            "building.geographicLocations":
              allOf:
                - $ref: "#/components/schemas/Issue"
              required:
                - values
              properties:
                values:
                  description: |
                    Liste des coordonnées géographiques de l'adresse corrigée.

                    Le nombre d'éléments de la liste doit être égal à la taille du tableau `relatedEntity`
                    et les éléments doivent être dans le même ordre que les éléments du tableau `relatedEntity`.

                    Si l'OC ne souhaite pas renseigner ces valeurs, il peut renseigner une liste vide.
                  type: array
                  minItems: 0
                  items:
                    $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Interop.openapi.yaml#/components/schemas/GeographicPoint
            "building.name":
              $ref: "#/components/schemas/Issue"
            "building.address.city":
              $ref: "#/components/schemas/Issue"
            "building.address.postcode":
              $ref: "#/components/schemas/Issue"
            "building.address.streetName":
              $ref: "#/components/schemas/Issue"
            "building.address.streetNr":
              $ref: "#/components/schemas/Issue"
            "building.address.streetNrSuffix":
              $ref: "#/components/schemas/Issue"
            "building.address.streetSuffix":
              $ref: "#/components/schemas/Issue"
            "building.address.streetType":
              $ref: "#/components/schemas/Issue"
            "building.address.code_insee":
              $ref: "#/components/schemas/Issue"
            "building.address.code_hexacle":
              $ref: "#/components/schemas/Issue"
            "building.address.code_hexacle_voie":
              $ref: "#/components/schemas/Issue"
            "building.address.code_rivoli":
              $ref: "#/components/schemas/Issue"
            "building.address.code_ban":
              $ref: "#/components/schemas/Issue"
            "building.pm.id":
              $ref: "#/components/schemas/Issue"

    AnomalieAdresseUpdateNbLogements:
      description: |
        *AnomalieAdresseUpdateNbLogements* est une anomalie de type `AnomalieAdresseUpdate`
        qui permet de mettre à jour le nombre de logements cibles d'un immeuble.

        Cette anomalie est unitaire et ne peut contenir qu'un seul immeuble.

        Cette anomalie ne peut contenir qu'une seule [Issue](#/components/schemas/Issue)
        dont la clef est `building.housingsNumber`.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseUpdate"
      properties:
        "@type":
          const: AnomalieAdresse.nbLogements
        relatedEntity:
          maxItems: 1
        issues:
          required:
            - "building.housingsNumber"
          properties:
            "building.housingsNumber":
              allOf:
                - $ref: "#/components/schemas/Issue"
              required:
                - value
              properties:
                value:
                  type: integer

    Issue:
      type: object
      properties:
        description:
          type: string
          description: Explication simple du problème lié à l'attribut en erreur.
        value:
          type: string
          description: Proposition de valeur de remplacement pour l'attribut en erreur.
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    Note:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Note.openapi.yaml#/components/schemas/Note
      properties:
        relatedEntity:
          description: |
            Relation entre la note et l'anomalie.
            Ce champ est renseigné par l'OI lors de la création de la note.
          type: array
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedAnomalie"

    Attachment:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/Attachment.openapi.yaml#/components/schemas/Attachment
      description: |
        An attachment is a file that is attached to an entity.

        Les extensions de fichier autorisées sont:

        * `csv`
        * `jpeg`
        * `jpg`
        * `png`
        * `svg`
        * `pdf`
        * `ods`
        * `odt`
        * `xlsx`
        * `docx`

        Les fichiers contenant du code exécutable comme des scripts ou des macros sont interdits.
      properties:
        mimeType:
          enum:
            - text/csv
            - image/jpeg
            - image/png
            - image/svg+xml
            - application/pdf
            - application/vnd.oasis.opendocument.spreadsheet
            - application/vnd.oasis.opendocument.text
            - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
            - application/vnd.openxmlformats-officedocument.wordprocessingml.document
        relatedEntity:
          description: |
            Relation entre l'attachment et l'anomalie.
            Ce champ est renseigné par l'OI lors de la création de l'attachment.
          type: array
          minItems: 1
          maxItems: 1
          readOnly: true
          items:
            allOf:
              - $ref: "#/components/schemas/RelatedAnomalie"

    AttachmentFormData:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/tools/attachment/attachment.openapi.yaml#/components/schemas/AttachmentFormData
      properties:
        attachment:
          $ref: "#/components/schemas/Attachment"

    Event:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/CloudEvent.openapi.yaml#/components/schemas/CloudEvent
      required:
        - time
        - subject
      properties:
        subject:
          description: Identifiant unique de l'anomalie.
          type: string
          format: uuid
        type:
          enum:
            - fr.interop.anomalieadresse.update
            - fr.interop.anomalieadresse.note.create
            - fr.interop.anomalieadresse.attachment.create
        datacontenttype:
          const: application/json
        data:
          oneOf:
            - $ref: "#/components/schemas/OneOfAnomalieAdresse"
            - $ref: "#/components/schemas/Note"
            - $ref: "#/components/schemas/Attachment"

    RelatedBuilding:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
      properties:
        "@referredType":
          const: "Building"
        role:
          const: "building"

    RelatedAnomalie:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/main/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
      properties:
        "@referredType":
          const: "AnomalieAdresse"
        role:
          const: "anomalie"
        id:
          description: Identifiant unique de l'anomalie.
