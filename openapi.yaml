openapi: 3.0.3

info:
  title: AnomalieAdresse API
  version: 2.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  description: |
    Cet outil a été créé afin de respecter l'obligation réglementaire
    indiquée dans la [Décision Arcep n° 2020-1432].

    Il permet le traitement d'une demande de création ou de modification d'adresses immeuble
    dans les IPE grâce à des flux normalisés.

    **Extrait de la [Décision Arcep n° 2020-1432]:**

      *«
      Compte tenu de l'importance des fichiers IPE qui permettent de connaître l'éligibilité sur les réseaux FttH,
      il apparaît raisonnable d'imposer aux opérateurs d'infrastructure la mise en place d'un processus inter-opérateurs
      afin de permettre aux opérateurs commerciaux de leur signaler ces immeubles manquants ou erronés.
      Comme pour les autres processus inter-opérateurs, il serait souhaitable qu'un tel processus de signalement
      soit identique chez l'ensemble des opérateurs d'infrastructure
      afin de permettre aux opérateurs commerciaux de mutualiser les développements nécessaires.
      »*

    ## Lexique

    #### OI

    **Opérateur d'immeuble**:
    Toute personne chargée de l'établissement ou de la gestion d'une ou plusieurs lignes dans un immeuble bâti,
    notamment dans le cadre d'une convention d'installation, d'entretien, de remplacement ou de gestion
    des lignes signée avec le propriétaire ou le syndicat de copropriétaires,
    en application de l'article [L33-6] du code des postes et des communications électroniques;
    l'opérateur d'immeuble n'est pas nécessairement un opérateur au sens de l'article [L33-1] du même code.

    #### OC

    **Opérateur Commercial**:
    Opérateur choisi par le client final pour la fourniture d'un service de télécommunications
    ou par un fournisseur d'accès au service pour la fourniture d'un service de télécommunications
    à son propre client final.

    ## Processus

    Les délais de traitement sont fixés par typologie dans la [Décision Arcep n° 2020-1432]:

    * Dans le cas d'un signalement unitaire, la correction de l'IPE par l'OI devra intervenir
      dans un délai d'une semaine après le signalement de l'OC pour les cas simples
      et de trois semaines maximum pour les cas complexes.

    * Dans le cas d'un signalement en masse, la correction de l'IPE par l'OI devra intervenir
      dans un délai de 2 mois maximum après le signalement de l'OC.

    Les anomalies sont catégorisées en fonction de leur complexité:

    * **Cas simple**: : cas ne nécessitant pas d'intervention sur le terrain, pas d'intervention sur le réseau ou de réalignement de référentiels.
    * **Cas complexe**: cas qui n'est pas un cas simple.

    Le processus doit prendre en compte deux catégories de signalements des anomalies de référencement d'adresses:

    * **Signalement unitaire**:
      par exemple anomalie détectée à partir d'une réclamation client.
      Il s'agit d'un signalement impactant une seule ligne de l'building.

    * **Signalement en masse**:
      par exemple liste d'anomalies détectées par contrôles informatisés ayant un critère commun (anomalie sur un même champ).
      Il s'agit d'un signalement unitaire impactant deux lignes IPE ou plus.
      Certains critères devront concerner la même zone géographique.

      La liste des critères communs n'est pas fermée et pourra être complétée
      à la demande d'un opérateur suite à la validation par consensus du groupe de travail Infrastructure.

    ## Types de signalement

    ![Types de signalement](./type.drawio.svg)

    ### AnomalieAdresseUpdate

    * **AnomalieAdresse.modification**

      Anomalie qui permet de mettre à jour un ou plusieurs attributs sur un ou plusieurs immeubles.

      | Attribut                             | Unicité de la valeur                   |
      | ------------------------------------ | -------------------------------------- |
      | `building.geographicLocations`       | Valeur spécifique à chaque immeuble    |
      | `building.name`                      | Valeur spécifique à chaque immeuble    |
      | `building.address.city`              | Valeur commune pour tous les immeubles |
      | `building.address.postcode`          | Valeur commune pour tous les immeubles |
      | `building.address.streetName`        | Valeur commune pour tous les immeubles |
      | `building.address.streetNr`          | Valeur spécifique à chaque immeuble    |
      | `building.address.streetNrSuffix`    | Valeur spécifique à chaque immeuble    |
      | `building.address.streetType`        | Valeur commune pour tous les immeubles |
      | `building.address.code_insee`        | Valeur commune pour tous les immeubles |
      | `building.address.code_hexacle`      | Valeur spécifique à chaque immeuble    |
      | `building.address.code_hexacle_voie` | Valeur commune pour tous les immeubles |
      | `building.address.code_rivoli`       | Valeur commune pour tous les immeubles |
      | `building.address.code_ban`          | Valeur spécifique à chaque immeuble    |
      | `building.pm.id`                     | Valeur commune pour tous les immeubles |

    * **AnomalieAdresse.nbLogements**

      Anomalie qui permet de mettre à jour le nombre de logements cible d'un immeuble.

    ### AnomalieAdresseCreation

    * **AnomalieAdresse.creation**

      Création d'une adresse inexistante dans l'IPE ou d'un immeuble neuf.

    * **AnomalieAdresse.newBuilding**

      Rajout d'un bâtiment à une adresse existante dans l'IPE.

    ## Workflow

    ![Workflow](./status.drawio.svg)

    **Possibilités de changement de status:**


    * `ACKNOWLEDGED` → `REJECTED`: Le ticket n'est pas recevable.

      **Ce changement de status ne peut être effectué que par l'OI.**

      **Ce changement de status n'est pas possible si le ticket a déjà été qualifié.**

      Les raisons (`statusChangeReason`) possibles sont:

      * `UNKNOWN_RESOURCE`: la ressource n'existe pas chez l'OI

      * `UNKNOWN_ZONE`: la zone géographique n'est pas couverte par l'OI

      * `DUPLICATE`: le ticket est en conflit avec un autre ticket
        (2 demandes actives de même type sur la même référence immeuble pour un `OC` donné)

        Le champ `statusChangeDetails` est obligatoire avec la référence du ticket en conflit.

      * `ALREADY_RESOLVED`: la ressource existe déjà chez l'OI

        Le champ `statusChangeDetails` est obligatoire avec la référence de la ressource existante.

      * `INVALID`: le ticket est invalide (champ manquant, valeur incorrecte, etc.)

        Le champ `statusChangeDetails` est obligatoire.

      * `OTHER`: autre raison non référencée par le protocole.

        Le champ `statusChangeDetails` est obligatoire.

      L'OI doit fournir la durée d'analyse dans le champ `acknowledgedDuration`.


    * `ACKNOWLEDGED` → `IN_PROGRESS`: Le ticket est recevable.

      **Ce changement de status ne peut être effectué que par l'OI.**

      **Il n'est plus possible de passer le ticket à `REJECTED` une fois ce changement de status effectué.**

      Le temps de traitement est décompté à partir de ce changement de status (`totalInProgressDuration`).

      L'OI doit renseigner:

      * Une date de résolution prévisionnelle dans le champ `expectedResolutionDate`
        (même si cette date est antérieure à la date courante).

      * Le qualification du ticket dans le champ `complexity`.

      * Le type de zone (`ZTD` ou `ZMD`) dans le champ `zone`.

      * La durée d'analyse dans le champ `acknowledgedDuration`.


    * `IN_PROGRESS` → `PENDING`: demande d'information complémentaire

      **Ce changement de status ne peut être effectué que par l'OI.**

      Le temps de traitement est suspendu à partir de ce changement de status.

      Le champ `statusChangeReason` doit être renseigné avec la valeur `WAITING_INFORMATION`.

      L'OC doit fournir en retour:

      * La liste des informations complémentaires attendues dans le champ `statusChangeDetails`.

        Ces informations peuvent être fournies dans une note ou un attachement.


    * `IN_PROGRESS` → `IN_PROGRESS`: requalification du ticket.

      **Ce changement de status ne peut être effectué que par l'OI.**

      L'OI doit renseigner:

      * La nouvelle qualification du ticket si changement dans le champ `complexity`.

      * Le nouveau type de zone si changement dans le champs `zone`.

      * La date de résolution prévisionnelle dans le champ `expectedResolutionDate`.

      * Le champ `statusChangeDetails` doit être renseigné avec la raison de la requalification.

      * Le champ `statusChangeReason` doit être renseigné avec la valeur `REQUALIFIED`.


    * `IN_PROGRESS` → `RESOLVED`: résolution du ticket

      **Ce changement de status ne peut être effectué que par l'OI.**

      L'OI doit renseigner:

      * La durée de résolution dans le champ `totalInProgressDuration`.

      * Pour les création, la référence de la ressource créée ou modifiée dans le champ `building.id`.

      * Le champ `statusChangeReason` doit être renseigné et peut avoir les valeurs suivantes:

        * `RESOLVED`: le ticket est résolu.

        * `UNRESOLVABLE`: le ticket ne peut pas être résolu.
          Le champ `statusChangeDetails` doit être renseigné avec la raison qui empêche la résolution du ticket.

      L'OC peut accepter la résolution du ticket en passant le status à `CLOSED`
      ou la refuser en passant le status à `ACKNOWLEDGED`.

      Le temps de traitement est suspendu à partir de ce changement de status.


    * `PENDING` → `ACKNOWLEDGED`: réponse à une demande d'information complémentaire

      **Ce changement de status ne peut être effectué que par l'OC.**

      Le champ `statusChangeReason` doit être renseigné avec la valeur `INFORMATION_PROVIDED`.

      L'OI doit renseigner:

      * La durée de gel dans le champ `totalPendingDuration`.


    * `PENDING` → `RESOLVED`: annulation du ticket

      **Ce changement de status ne peut être effectué que par l'OI.**

      Le ticket est annulé car l'OC n'a pas répondu à la demande d'information complémentaire
      dans les délais impartis. *Ce délai est à la disposition de l'OI*.

      Le champ `statusChangeReason` doit être renseigné avec la valeur `DELAY_ANSWER_EXPIRED`.


    * `RESOLVED` → `CLOSED`: validation de la résolution du ticket.

      **Ce changement de status ne peut être effectué que par l'OC ou l'OI.**

      Le ticket est clos.

      * Si ce changement est effectué par l'OC, le ticket est clos par validation de la résolution.

        Le champ `statusChangeReason` doit être renseigné avec la valeur `RESOLUTION_ACCEPTED`.

      * Si le changement est effectué par l'OI, le ticket est clos
        car l'OC n'a pas répondu à la résolution dans les délais impartis.
        *Ce délai est à la disposition de l'OI*.

        Le champ `statusChangeReason` doit être renseigné avec la valeur `DELAY_VALIDATION_EXPIRED`.

        L'OI doit renseigner:

        * La durée de gel dans le champ `totalPendingDuration`.

    * `RESOLVED` → `ACKNOWLEDGED`: refus de la résolution du ticket.

      **Ce changement de status ne peut être effectué que par l'OC.**

      La résolution du ticket est refusée par l'OC.

      * Le champ `statusChangeReason` doit être renseigné avec la valeur `RESOLUTION_REFUSED`.
      * Le champ `statusChangeDetails` doit être renseigné avec la raison du refus.

    * `ACKNOWLEDGED|IN_PROGRESS|PENDING` → `CANCELED`: annulation du ticket par l'OC.

      **Ce changement de status ne peut être effectué que par l'OC.**

      Le ticket est annulé par l'OC.

      Le temps de traitement est annulé à partir de ce changement de status.

      * Le champ `statusChangeDetails` doit être renseigné avec la raison de l'annulation.


    ## Pagination

    Les listes de ressources sont paginées.

    * La valeur par défaut d'une page est `limit=50` et `offset=0`.
    * La valeur maximale de `limit` est `100`.

    ## Délais de traitement

    Les délais de traitement sont fixés par typologie:

    * cas simple: 1 semaine
    * cas complexe: 3 semaines
    * signalement en masse: 8 semaines


    ## Dépendances

    Cette API utilise une architecture proxyfié pour la gestion des dépendances.

    ![Proxyfied architecture schema](https://raw.githubusercontent.com/before-interop/common/v1/schema/architecture.drawio.svg)

    * [TroubleTicket](https://before-interop.github.io/common/v1/?urls.primaryName=TroubleTicket)
    * [Attachment](https://before-interop.github.io/common/v1/?urls.primaryName=Attachment)
    * [Note](https://before-interop.github.io/common/v1/?urls.primaryName=Note)
    * [Event](https://before-interop.github.io/common/v1/?urls.primaryName=Event)


    [Décision Arcep n° 2020-1432]: https://www.arcep.fr/uploads/tx_gsavis/20-1432.pdf
    [L33-1]: https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000047293234
    [L33-6]: https://www.legifrance.gouv.fr/codes/article_lc/LEGIARTI000037671945

servers:
  - url: "{protocol}://{host}:{port}{basePath}"
    variables:
      protocol:
        enum:
          - https
          - http
        default: https
      host:
        default: localhost
      port:
        default: "8080"
      basePath:
        default: /api/v2

tags:
  - name: TroubleTicket
    description: TroubleTicket management
  - name: Note
    description: Note management
  - name: Attachment
    description: Attachment management
  - name: Event
    description: Event management
  - name: OI
    description: OI endpoints
  - name: OC
    description: OC endpoints

paths:
  /anomalie-adresse:
    get:
      operationId: getAllAnomalieAdresses
      tags:
        - TroubleTicket
        - OI
      summary: Get all trouble tickets
      description: Get all trouble tickets
      parameters: &searchAndPaginateParameters
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/limit
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/offset
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/parameters/sort
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The list of trouble tickets
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AnomalieAdresseBase"
        "400": &response400
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-400
          description: |
            **Bad Request**

            This error occurs when a query parameter or the body is invalid.

            * The `reason` field of the error response can contain information about the error.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - TroubleTicket
        - OI
      operationId: countAnomalieAdresses
      summary: Count the number of trouble tickets
      description: Count the number of trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of trouble tickets.
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - TroubleTicket
        - OI
      operationId: createAnomalieAdresse
      summary: Create a trouble ticket
      description: Create a trouble ticket
      requestBody:
        description: The trouble ticket to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseBase"
      responses:
        "201": &troubleTicket201
          description: The trouble ticket
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnomalieAdresseBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "403": &response403
          description: |
            **Forbidden**

            Le serveur a compris la requête, mais refuse de l'exécuter car le client n'a pas respecté le processus de création ou de mise à jour.

            Exemple: passage du status `ACKNOWLEDGED` à `RESOLVED` sans passer par le status `IN_PROGRESS`.

            * Le champ `reason` de la réponse d'erreur doit contenir la liste des tickets en conflit séparés par des virgules.
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - TroubleTicket
        - OI
      operationId: getAnomalieAdresse
      summary: Get a trouble ticket
      description: Get a trouble ticket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/fields.openapi.yaml#/components/parameters/fields
      responses:
        "200":
          description: The trouble ticket
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnomalieAdresseBase"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "404": &response404
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-404
          description: |
            **Not Found**

            This error occurs when the resource does not exist or is not visible by the user.

        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    put:
      tags:
        - TroubleTicket
        - OI
      operationId: updateAnomalieAdresse
      summary: Update a trouble ticket
      description: Update a trouble ticket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    patch:
      tags:
        - TroubleTicket
        - OI
      operationId: partialUpdateAnomalieAdresse
      summary: Partially update a trouble ticket
      description: Partially update a trouble ticket
      requestBody:
        description: The trouble ticket to update
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseBase"
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/parameters/If-Match
      responses:
        "200": *troubleTicket201
        "400": *response400
        "403": *response403
        "404": *response404
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}/note:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - Note
        - OI
      operationId: getAnomalieAdresseNotes
      summary: Get all notes of a trouble ticket
      description: Get all notes of a trouble ticket
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AnomalieAdresseNote"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Note
        - OI
      operationId: countAnomalieAdresseNotes
      summary: Count the number of notes of a trouble ticket
      description: Count the number of notes of a trouble ticket matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of notes
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Note
        - OI
      operationId: createAnomalieAdresseNote
      summary: Create a note for a trouble ticket
      description: Create a note for a trouble ticket
      requestBody:
        description: The note to create
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseNote"
      responses:
        "201":
          description: The created note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnomalieAdresseNote"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}/attachment:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"

    get:
      tags:
        - Attachment
        - OI
      operationId: getAnomalieAdresseAttachments
      summary: Get all attachments of a trouble ticket
      description: Get all attachments of a trouble ticket
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AnomalieAdresseAttachment"
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Attachment
        - OI
      operationId: countAnomalieAdresseAttachments
      summary: Count the number of attachments of a trouble ticket
      description: Count the number of attachments of a trouble ticket matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of attachments
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Attachment
        - OI
      operationId: createAnomalieAdresseAttachment
      summary: Create an attachment for a trouble ticket
      description: Create an attachment for a trouble ticket
      requestBody:
        description: The attachment to create
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/AnomalieAdresseAttachmentFormData"
      responses:
        "201":
          description: The created attachment
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnomalieAdresseAttachment"
          headers:
            ETag:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/update.openapi.yaml#/components/headers/ETag
        "400": *response400
        "404": *response404
        "413":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-413
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

  /anomalie-adresse/{AnomalieAdresseId}/attachment/{AttachmentId}/content:
    parameters:
      - $ref: "#/components/parameters/anomalieAdresseId"
      - $ref: "#/components/parameters/attachmentId"

    get:
      tags:
        - Attachment
        - OI
      operationId: downloadAnomalieAdresseAttachment
      summary: Download an attachment of a trouble ticket
      description: Download an attachment of a trouble ticket
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-None-Match
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Modified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/If-Unmodified-Since
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/tools/attachment/attachment.openapi.yaml#/components/parameters/Range
      responses:
        "200":
          description: The content of the attachment
          content:
            application/octet-stream:
              schema:
                format: binary
                type: string
        "404": *response404
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default
        "412":
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-412

  /anomalie-adresse/event:
    get:
      tags:
        - Event
        - OI
      operationId: getAnomalieAdresseEvents
      summary: Get all events of all trouble tickets
      description: Get all events of all trouble tickets
      parameters: *searchAndPaginateParameters
      responses:
        "200":
          description: The list of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
            X-Result-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Result-Count
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/EventAnomalieAdresse"
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    head:
      tags:
        - Event
        - OI
      operationId: countAnomalieAdresseEvents
      summary: Count the number of events of all trouble tickets
      description: Count the number of events of all trouble tickets matching the given criteria.
      parameters:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/filters.openapi.yaml#/components/parameters/filters
      responses:
        "200":
          description: The number of events
          headers:
            X-Total-Count:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/utils/paginate.openapi.yaml#/components/headers/X-Total-Count
        "400": *response400
        default:
          $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/default

    post:
      tags:
        - Event
        - OC
      operationId: receiveAnomalieAdresseEvent
      summary: Receive an event for a trouble ticket
      description: Receive an event for a trouble ticket
      requestBody:
        description: The event to receive
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EventAnomalieAdresse"
      responses:
        "200":
          description: The event has been received
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        "204":
          description: The event has been received

        default:
          description: |
            L'événement a été reçu avec succès.

            La réponse n'a pas l'obligation de contenir un body.
            Si l'OC retourne un body, celui-ci pourra être enregistré dans le journal de l'OI.
        "400": *response400
        "403": *response403
        "404": *response404
        "500":
          description: |
            **Internal Server Error**

            This error occurs when the server encountered an unexpected condition that prevented it from fulfilling the request.

            * The `reason` field of the error response can contain information about the error.
          content:
            application/json:
              schema:
                $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/responses/errors.openapi.yaml#/components/responses/Error-500
        "501":
          description: |
            **Not Implemented**

            This error occurs when the server does not support the functionality required to fulfill the request.

            * The `reason` field of the error response can contain information about the error.

components:
  parameters:
    anomalieAdresseId:
      name: AnomalieAdresseId
      in: path
      description: The id of the trouble ticket
      required: true
      schema:
        type: string
        format: uuid
        example: 123e4567-e89b-12d3-a456-426614174000

    attachmentId:
      name: AttachmentId
      in: path
      description: The id of the attachment
      required: true
      schema:
        type: string
        format: uuid
        example: 123e4567-e89b-12d3-a456-426614174000

  schemas:
    AnomalieAdresseAttachmentFormData:
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseAttachment"
        - $ref: "https://raw.githubusercontent.com/before-interop/common/refs/heads/v1/tools/attachment/attachment.openapi.yaml#/components/schemas/AttachmentFormData"

    AnomalieAdresseAttachment:
      allOf:
        - $ref: "https://raw.githubusercontent.com/christophelach/defecto-interop-common/refs/heads/generic-troubleTicket-model-for_codeGen/common/schemas/Attachment.openapi.yaml#/components/schemas/TroubleTicketAttachment"
        - properties:
            "@baseType":
              type: string
              default: "AnomalieAdresse"
            mimeType:
              enum:
                - text/csv
                - image/jpeg
                - image/png
                - image/svg+xml
                - application/pdf
                - application/vnd.oasis.opendocument.spreadsheet
                - application/vnd.oasis.opendocument.text
                - application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
                - application/vnd.openxmlformats-officedocument.wordprocessingml.document
              type: string
            relatedEntity:
              description: |
                Relation entre l'attachment et l'anomalie.
                Ce champ est renseignÃ© par l'OI lors de la crÃ©ation de l'attachment.
              items:
                $ref: "#/components/schemas/RelatedAnomalie"
              maxItems: 1
              minItems: 1
              readOnly: true
              type: array

    AnomalieAdresseNote:
      allOf:
        - $ref: https://raw.githubusercontent.com/christophelach/defecto-interop-common/refs/heads/generic-troubleTicket-model-for_codeGen/common/schemas/Note.openapi.yaml#/components/schemas/TroubleTicketNote
        - properties:
            "@baseType":
              type: string
              default: "AnomalieAdresse"
            relatedEntity:
              description: |
                Relation entre la note et l'anomalie.
                Ce champ est renseignÃ© par l'OI lors de la crÃ©ation de la note.
              items:
                $ref: "#/components/schemas/RelatedAnomalie"
              maxItems: 1
              minItems: 1
              readOnly: true
              type: array

    AnomalieAdresse:
      allOf:
        # - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
        - $ref: https://raw.githubusercontent.com/christophelach/defecto-interop-common/refs/heads/generic-troubleTicket-model-for_codeGen/common/schemas/TroubleTicket.openapi.yaml#/components/schemas/TroubleTicket
        - properties:
            "@baseType":
              type: string
            "@type":
              type: string
            priority:
              type: string
              enum:
                - LOW
                - MEDIUM
                - HIGH
            severity:
              type: string
            ticketType:
              type: string
              enum:
                - OC_REQUEST
                - CUSTOMER_REQUEST
              description: |
                Types de ticket.

                Les valeurs possibles sont:

                * `CUSTOMER_REQUEST`: Ticket crÃ©Ã© par l'OC suite Ã  une demande client final
                  qui souhaite passer commande.
                * `OC_REQUEST`: Ticket crÃ©Ã© par l'OC sans demande client final.

                La valeur est renseignÃ©e par l'OC Ã  la crÃ©ation du ticket.
                    default: OC_REQUEST
            relatedEntity:
              type: object
            status:
              type: string
              enum:
                - ACKNOWLEDGED
                - IN_PROGRESS
                - PENDING
                - RESOLVED
                - CLOSED
                - REJECTED
                - CANCELED
      discriminator:
        propertyName: "@type"
        mapping:
          AnomalieAdresse.creation: "#/components/schemas/AnomalieAdresseCreation"
          AnomalieAdresse.newBuilding: "#/components/schemas/AnomalieAdresseNewBuilding"
          AnomalieAdresse.modification: "#/components/schemas/AnomalieAdresseUpdateImb"
          AnomalieAdresse.nbLogements: "#/components/schemas/AnomalieAdresseUpdateNbLogements"
      description:
        "A trouble ticket is a record of an issue that is created, tracked,\
        \ and managed by a trouble ticket management system"
      externalDocs:
        url: https://datamodel.tmforum.org/en/latest/Common/TroubleTicket

    AnomalieAdresseBase:
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresse"
        - properties:
            "@type":
              type: string
            acknowledgedDuration:
              description: Temps cumulé du ticket dans le status `ACKNOWLEDGED`.
              readOnly: true
              type: integer
            totalInProgressDuration:
              description: Temps cumulé du ticket dans le status `IN_PROGRESS`.
              readOnly: true
              type: integer
            totalPendingDuration:
              description: Temps cumulé du ticket dans le status `PENDING`.
              readOnly: true
              type: integer
            totalDuration:
              description:
                Temps cumulé du ticket dans les status `ACKNOWLEDGED` et
                `IN_PROGRESS`.
              readOnly: true
              type: integer
            resolvedToAcknowledgedDuration:
              description:
                Temps cumulé du ticket dans les status `RESOLVED` avant
                le passage Ã  `ACKNOWLEDGED`.
              readOnly: true
              type: integer
            resolvedToClosedDuration:
              description:
                Temps cumulé du ticket dans les status `RESOLVED` avant
                le passage Ã  `CLOSED`.
              readOnly: true
              type: integer
            expectedResolutionDate:
              description:
                The expected resolution date determined by the trouble ticket
                system.
              format: date-time
              nullable: true
              readOnly: true
              type: string
            statusChangeReason:
              enum:
                - ALREADY_RESOLVED
                - DELAY_ANSWER_EXPIRED
                - DELAY_VALIDATION_EXPIRED
                - DUPLICATE
                - INFORMATION_PROVIDED
                - INVALID
                - OTHER
                - REQUALIFIED
                - RESOLUTION_ACCEPTED
                - RESOLUTION_REFUSED
                - RESOLVED
                - UNKNOWN_RESOURCE
                - UNKNOWN_ZONE
                - UNRESOLVABLE
                - WAITING_INFORMATION
              type: string
            complexity:
              description: |
                ComplexitÃ© du ticket.
                La valeur est renseignÃ©e par l'OI lors du passage Ã  l'Ã©tat `IN_PROGRESS`.

                Les valeurs possibles sont:

                * `SIMPLE`: cas ne nÃ©cessitant pas d'intervention sur le terrain,
                  pas d'intervention sur le rÃ©seau ou de rÃ©alignement de rÃ©fÃ©rentiels.
                * `COMPLEX`: cas qui n'est pas un cas simple.
                * `MASSE`: cas qui concerne les anomalies en masse.
              enum:
                - SIMPLE
                - COMPLEX
                - MASSE
              readOnly: true
              type: string
            externalId:
              description: RÃ©fÃ©rence interne du ticket de l'OC.
              type: string
            siren:
              description: NumÃ©ro SIREN de l'entreprise cliente.
              type: string
            siret:
              description: NumÃ©ro SIRET de l'entreprise cliente.
              type: string
            zone:
              description: |
                Zone de traitement du ticket.

                La valeur est renseignÃ©e par l'OI lors de la qualification du ticket
                et du passage au status `IN_PROGRESS`.
              enum:
                - ZTD
                - ZMD
              readOnly: true
              type: string
      required:
        - "@type"
        - code_oc
        - code_oi
      example:
        statusChangeReason: ALREADY_RESOLVED
        complexity: SIMPLE
        siren: siren
        code_oc: FTEL
        "@type": "@type"
        resolutionDate: 2000-01-23T04:56:07.000+00:00
        description: description
        siret: siret
        code_oi: FTEL
        "@baseType": AnomalieAdresse
        acknowledgedDuration: 0
        zone: ZTD
        totalPendingDuration: 1
        resolvedToClosedDuration: 2
        id: 046b6c7f-0b8a-43b9-b35d-6489e6daee91
        "@schemaLocation": https://raw.githubusercontent.com/tmforum-apis/Open_Api_And_Data_Model/master/schemas/Common/TroubleTicket.schema.json
        requestedResolutionDate: 2000-01-23T04:56:07.000+00:00
        severity: severity
        totalDuration: 5
        totalInProgressDuration: 6
        relatedEntity:
          - "@referredType": Building
            role: building
            "@baseType": RelatedEntity
            "@type": RelatedEntity
            id: id
          - "@referredType": Building
            role: building
            "@baseType": RelatedEntity
            "@type": RelatedEntity
            id: id
        resolvedToAcknowledgedDuration: 5
        externalId: externalId
        ticketType: OC_REQUEST
        priority: LOW
        relatedParty:
          - "@referredType": "@referredType"
            role: role
            "@baseType": RelatedEntity
            "@type": RelatedEntity
            id: id
          - "@referredType": "@referredType"
            role: role
            "@baseType": RelatedEntity
            "@type": RelatedEntity
            id: id
        expectedResolutionDate: 2000-01-23T04:56:07.000+00:00
        name: name
        status: ACKNOWLEDGED

    AnomalieAdresseCreation:
      description: |
        *AnomalieAdresseCreation* permet la création d'une adresse inexistante dans l'IPE
        ou d'une immeuble neuf.

        Dans la mesure du possible, l'OC doit fournir les informations suivantes:

        * Quadrulet (`code_rivoli`, `code_insee`, `streetNr`, `streetNrSuffix`)
        * `code_hexacle`
        * `code_ban`
        * N-uplet (`postcode`, `city`, `streetName`)

        Pour les immeubles neufs, l'OC peut fournir les informations suivantes
        sur le bailleur et le promoteur immobilier grâce aux champs `realEstateLessor` et `realEstateDeveloper`.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
        - required:
            - building
          properties:
            relatedEntity:
              items:
                $ref: "#/components/schemas/RelatedBuilding"
              type: array
            "@type":
              type: string
              default: "AnomalieAdresse.creation"
            building:
              $ref: "#/components/schemas/AnomalieAdresseCreationBuilding"

    AnomalieAdresseCreationBuilding:
      allOf:
        - $ref: "#/components/schemas/Building"
      required:
        - address
        - geographicLocation
        - newConstruction
        - type

    AnomalieAdresseNewBuilding:
      description: |
        *AnomalieAdresseNewBuilding* permet de rajouter un nouveau bâtiment à une adresse existante dans l'IPE.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
        - properties:
            "@type":
              type: string
              default: "AnomalieAdresse.newBuilding"
            relatedEntity:
              type: array
              minItems: 1
              maxItems: 1
              items:
                $ref: "#/components/schemas/RelatedBuilding"
            building:
              $ref: "#/components/schemas/AnomalieAdresseNewBuildingBuilding"
      required:
        - building
        - relatedEntity

    AnomalieAdresseNewBuildingBuilding:
      allOf:
        - $ref: "#/components/schemas/Building"
      required:
        - name
        - geographicLocation
        - newConstruction
        - type

    AnomalieAdresseUpdate:
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseBase"
        - properties:
            "@type":
              type: string
              default: "AnomalieAdresse.update"
            sizeRefs:
              type: integer
              description: |
                Nombre d'immeubles cibles de l'anomalie.

                La valeur est renseignée par l'OI à la création du ticket.
                Elle est égale à la taille du tableau `relatedEntity`.
                Elle permet de rechercher plus efficacement les anomalies
                et de facilement différencier les traitement unitaires et en masse.
              readOnly: true
      required:
        - relatedEntity

    AnomalieAdresseUpdateImb:
      description: |
        *AnomalieAdresseUpdateImb* est une anomalie de type `AnomalieAdresseUpdate`
        qui permet de mettre à jour un des attributs en masse d'un ou plusieurs immeubles.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseUpdate"
        - properties:
            "@type":
              type: string
              default: "AnomalieAdresse.modification"
            relatedEntity:
              description: |
                Liste des immeubles cibles de l'anomalie.

                Si cette liste est supérieure à 1, alors l'OI traite les cas possibles de la demande en masse
                et demande la résolution du ticket.
                L'OC pourra rouvrir un ticket unitaire si besoin pour chaque cas non résolus.
              type: array
              minItems: 1
              items:
                $ref: "#/components/schemas/RelatedBuilding"
            issues:
              $ref: "#/components/schemas/AnomalieAdresseUpdateImbIssues"
      required:
        - issues

    AnomalieAdresseUpdateImbIssues:
      description: "Les anomalies spécifiques en masse"
      type: object
      properties:
        "building.geographicLocations":
          allOf:
            - $ref: "#/components/schemas/IssueArray"
            - description: Liste des coordonnées géographiques de l'adresse corrigée.
              properties:
                value:
                  type: array
                  items:
                    $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/GeographicPoint
        "building.name":
          allOf:
            - $ref: "#/components/schemas/IssueArray"
            - properties:
                value:
                  type: array
                  items:
                    $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/Building/allOf/1/properties/name
                toBlank:
                  type: boolean
                  description: |
                    Indique si l'attribut en erreur doit être mis à blanc.
                    Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
                    Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.
        "building.address.city":
          description: |
            Nom de la commune.

            Ce champ est nommé `CommuneImmeuble` dans le fichier IPE.
          properties:
            value:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/city
        "building.address.postcode":
          description: |
            Code postal.

            Ce champ est nommé `CodePostalImmeuble` dans le fichier IPE.
          properties:
            value:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/postcode
        "building.address.streetName":
          allOf:
            - $ref: "#/components/schemas/Issue"
            - description: |
                Nom de la voie.

                Ce champ est nommé `NomVoieImmeuble` dans le fichier IPE.
              properties:
                value:
                  $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetName
        "building.address.streetNr":
          allOf:
            - $ref: "#/components/schemas/Issue"
            - properties:
                description:
                  type: string
                  description: Explication simple du problème lié à l'attribut en erreur.
                value:
                  type: array
                  items:
                    $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetNr
        "building.address.streetNrSuffix":
          allOf:
            - $ref: "#/components/schemas/Issue"
            - description: |
                Complément du numéro de la voie.

                Ce champ est nommé `ComplementNumeroVoieImmeuble` dans le fichier IPE.
              properties:
                value:
                  $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetNrSuffix
                toBlank:
                  type: boolean
                  description: |
                    Indique si l'attribut en erreur doit être mis à blanc.

                    Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
                    Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.
        "building.address.streetType":
          allOf:
            - $ref: "#/components/schemas/Issue"
            - description: |
                Type de la voie.

                Ce champ est nommé `TypeVoieImmeuble` dans le fichier IPE.
              properties:
                value:
                  $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/streetType
        "building.address.code_insee":
          description: |
            Code INSEE de la commune.

            Ce champ est nommé `CodeInseeImmeuble` dans le fichier IPE.
          properties:
            value:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_insee
        "building.address.code_hexacle":
          allOf:
            - $ref: "#/components/schemas/Issue"
            - properties:
                description:
                  type: string
                  description: Explication simple du problème lié à l'attribut en erreur.
                value:
                  type: array
                  items:
                    $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_hexacle
        "building.address.code_hexacle_voie":
          allOf:
            - $ref: "#/components/schemas/Issue"
            - description: |
                Code Hexacle de la voie.

                Ce champ est nommé `CodeHexacleVoie` dans le fichier IPE.
              properties:
                value:
                  $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_hexacle_voie
        "building.address.code_rivoli":
          allOf:
            - $ref: "#/components/schemas/Issue"
            - description: |
                Code Rivoli de la commune.

                Ce champ est nommé `CodeVoieRivoliImmeuble` dans le fichier IPE.
              properties:
                value:
                  $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_rivoli
        "building.address.code_ban":
          allOf:
            - $ref: "#/components/schemas/IssueArray"
            - description: |
                Code BAN de l'immeuble.

                Ce champ est nommé `CodeBAN` dans le fichier IPE.
              properties:
                value:
                  type: array
                  items:
                    $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/GeographicAddress.openapi.yaml#/components/schemas/GeographicAddress/allOf/1/properties/code_ban
                toBlank:
                  type: boolean
                  description: |
                    Indique si l'attribut en erreur doit être mis à blanc.

                    Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
                    Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.
        "building.pm.id":
          description: |
            Identifiant du PM associé à l'immeuble.

            Ce champ est nommé `ReferencePM` dans le fichier IPE.
          properties:
            value:
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/PM/properties/id

    AnomalieAdresseUpdateNbLogements:
      description: |
        *AnomalieAdresseUpdateNbLogements* est une anomalie de type `AnomalieAdresseUpdate`
        qui permet de mettre à jour le nombre de logements cibles d'un immeuble.

        Cette anomalie est unitaire et ne peut contenir qu'un seul immeuble.

        Cette anomalie ne peut contenir qu'une seule [Issue](#/components/schemas/Issue)
        dont la clef est `building.housingsNumber`.
      allOf:
        - $ref: "#/components/schemas/AnomalieAdresseUpdate"
        - properties:
            "@type":
              type: string
              default: "AnomalieAdresse.nbLogements"
            relatedEntity:
              description: |
                Liste des immeubles cibles de l'anomalie.

                Si cette liste est supérieure à 1, alors l'OI traite les cas possibles de la demande en masse
                et demande la résolution du ticket.
                L'OC pourra rouvrir un ticket unitaire si besoin pour chaque cas non résolus.
              type: array
              minItems: 1
              maxItems: 1
              items:
                $ref: "#/components/schemas/RelatedBuilding"
            issues:
              $ref: "#/components/schemas/AnomalieAdresseUpdateNbLogementsIssues"
      required:
        - issues
        - relatedEntity

    AnomalieAdresseUpdateNbLogementsIssues:
      type: object
      description: "Les issues relatives à la mise à jour du nombre de logements d'un immeuble."
      required:
        - "building.housingsNumber"
      properties:
        "building.housingsNumber":
          required:
            - value
          properties:
            value:
              type: integer
              minimum: 0
          description: |
            Nombre de logement de l'immeuble.

            Ce champ est nommé `NombreLogementsAdresseIPE` dans le fichier IPE.

    Building:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Interop.openapi.yaml#/components/schemas/Building
        - properties:
            id:
              description: |
                Identifiant unique de l'immeuble.

                La valeur est renseignée par l'OI à la résolution du ticket.
              type: string
              readOnly: true
            neighbor:
              $ref: "#/components/schemas/RelatedBuilding"
            realEstateDeveloper: # Promoteur immobilier
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Company.openapi.yaml#/components/schemas/Company
            realEstateLessor: # Bailleur
              $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/Company.openapi.yaml#/components/schemas/Company
            plot:
              description: Parcelle cadastrale.
              type: string
              pattern: ^[0-9A-Z]+$
            newConstruction:
              description: Indique si le bâtiment est neuf.
              type: boolean

    Issue:
      type: object
      properties:
        description:
          type: string
          description: Explication simple du problème lié à l'attribut en erreur.
        toBlank:
          type: boolean
          description: |
            Indique si l'attribut en erreur doit être mis à blanc.

            Si la valeur est `true`, l'attribut en erreur sera mis à blanc.
            Si la valeur est `false`, l'attribut en erreur ne sera pas mis à blanc.

    IssueArray:
      type: object
      description: |
        Le nombre d'éléments de la liste comprise dans value doit être égal à la taille du tableau `relatedEntity`
        et les éléments doivent être dans le même ordre que les éléments du tableau `relatedEntity`.

        Si l'OC ne souhaite pas renseigner ces valeurs, il peut mettre la valeur `null` dans la liste
        et remplir de champs `description` pour expliquer pourquoi les valeurs ne sont pas renseignées.
        (ex: "Les noms des bâtiments sont renseignés dans le fichier en PJ.")
      properties:
        description:
          type: string
          description: Explication simple du problème lié à l'attribut en erreur.

    EventAnomalieAdresse:
      allOf:
        - $ref: https://raw.githubusercontent.com/christophelach/defecto-interop-common/refs/heads/generic-troubleTicket-model-for_codeGen/common/schemas/CloudEvent.openapi.yaml#/components/schemas/TroubleTicketEvent
        - properties:
            "@baseType":
              type: string
              default: "AnomalieAdresse"
            subject:
              description: Identifiant unique de l'anomalie.
              type: string
              format: uuid
            type:
              type: string
            datacontenttype:
              type: string
              default: "application/json"
              example: "application/json"
      discriminator:
        propertyName: type
        mapping:
          fr.interop.anomalieadresse.update: "#/components/schemas/EventAnomalieAdresseUpdate"
          fr.interop.anomalieadresse.note.create: "#/components/schemas/EventAnomalieAdresseNote"
          fr.interop.anomalieadresse.attachment.create: "#/components/schemas/EventAnomalieAdresseCreateAttachment"
          fr.interop.anomalieadresse.attachment.update: "#/components/schemas/EventAnomalieAdresseUpdateAttachment"
      required:
        - type

    EventAnomalieAdresseUpdate:
      allOf:
        - $ref: "#/components/schemas/EventAnomalieAdresse"
        - properties:
            data:
              $ref: "#/components/schemas/AnomalieAdresseBase"
            type:
              type: string
              default: "fr.interop.anomalieadresse.update"

    EventAnomalieAdresseNote:
      allOf:
        - $ref: "#/components/schemas/EventAnomalieAdresse"
        - properties:
            data:
              $ref: "#/components/schemas/AnomalieAdresseNote"
            type:
              type: string
              default: "fr.interop.anomalieadresse.note.create"

    EventAnomalieAdresseCreateAttachment:
      allOf:
        - $ref: "#/components/schemas/EventAnomalieAdresse"
        - properties:
            data:
              $ref: "#/components/schemas/AnomalieAdresseAttachment"
            type:
              type: string
              default: "fr.interop.anomalieadresse.attachment.create"

    EventAnomalieAdresseUpdateAttachment:
      allOf:
        - $ref: "#/components/schemas/EventAnomalieAdresse"
        - properties:
            data:
              $ref: "#/components/schemas/AnomalieAdresseAttachment"
            type:
              type: string
              default: fr.interop.anomalieadresse.attachment.update

    RelatedBuilding:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
        - properties:
            "@referredType":
              type: string
              default: "Building"
            role:
              type: string
              default: "building"

    RelatedAnomalie:
      allOf:
        - $ref: https://raw.githubusercontent.com/before-interop/common/v1/common/schemas/RelatedEntity.openapi.yaml#/components/schemas/RelatedEntity
        - properties:
            "@referredType":
              type: string
              default: "AnomalieAdresse"
            role:
              type: string
              default: "anomalie"
            id:
              description: Identifiant unique de l'anomalie.
              type: string
